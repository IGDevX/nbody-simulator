name: Connect to VPN and Deploy

on:
  push:
    branches:
      - prod

jobs:
  vpn-connect:
    runs-on: ubuntu-latest

    steps:
      - name: Install Required Packages
        run: |
          sudo apt update
          sudo apt-get install -y strongswan xl2tpd net-tools

      - name: Add VPN Connection
        run: |
          sudo bash -c 'cat > /etc/ipsec.conf <<EOF
          conn myvpn
            auto=add
            keyexchange=ikev1
            authby=secret
            type=transport
            left=%defaultroute
            leftprotoport=17/1701
            rightprotoport=17/1701
            right=${{ secrets.VPN_GATEWAY }}
            ike=3des-sha1-modp1024
            esp=3des-sha1
          EOF'

          sudo bash -c 'cat > /etc/ipsec.secrets <<EOF
          : PSK "${{ secrets.VPN_PSK }}"
          EOF'

          sudo chmod 600 /etc/ipsec.secrets

          sudo bash -c 'cat > /etc/xl2tpd/xl2tpd.conf <<EOF
          [lac myvpn]
          lns = ${{ secrets.VPN_GATEWAY }}
          ppp debug = yes
          pppoptfile = /etc/ppp/options.l2tpd.client
          length bit = yes
          EOF'

          sudo bash -c 'cat > /etc/ppp/options.l2tpd.client <<EOF
          ipcp-accept-local
          ipcp-accept-remote
          refuse-eap
          require-chap
          noccp
          noauth
          mtu 1280
          mru 1280
          noipdefault
          defaultroute
          usepeerdns
          connect-delay 5000
          domain "${{ secrets.VPN_NT_DOMAIN }}"
          name "${{ secrets.VPN_USERNAME }}"
          password "${{ secrets.VPN_PASSWORD }}"
          EOF'

          sudo chmod 600 /etc/ppp/options.l2tpd.client

      - name: Start VPN Connection
        run: |
          sudo mkdir -p /var/run/xl2tpd
          sudo touch /var/run/xl2tpd/l2tp-control
          sudo service ipsec restart
          sudo service xl2tpd restart

          sudo ipsec up myvpn
          echo "c myvpn" | sudo tee /var/run/xl2tpd/l2tp-control

          while ! ip addr show ppp0 | grep -q "inet "; do
              echo "Waiting for ppp0 to be up..."
              sleep 1
          done
          echo "ppp0 is up!"

          sudo ip route add $(nslookup ${{ secrets.DOKKU_ADDR }} | awk '/^Address: / { print $2 }' | tail -n1) dev ppp0

      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run Build
        run: ./gradlew build

      - name: Setup SSH Key for Dokku
        run: |
          echo "Setting up SSH key..."
          mkdir -p ~/.ssh
          cat <<EOF > ~/.ssh/id_rsa
          ${{ secrets.DOKKU_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa

      - name: Run tasks after VPN connection
        run: |
          echo "VPN Connected! Now executing required commands..."

          ssh-keyscan -H "${{ secrets.DOKKU_ADDR }}" >> ~/.ssh/known_hosts || { echo "‚ùå ssh-keyscan failed"; exit 1; }
          git remote add dokku dokku@${{ secrets.DOKKU_ADDR }}:nbody-simulator-backend || { echo "‚ùå git remote add failed"; exit 1; }
          git push dokku prod:master || { echo "‚ùå git push failed"; exit 1; }

      - name: Disconnect VPN
        if: always()
        run: |
          echo "d myvpn" | sudo tee /var/run/xl2tpd/l2tp-control
          sudo ipsec down myvpn

      - name: Notify Deployment Success
        if: success()
        run: echo "üöÄ Successfully deployed to Dokku!"